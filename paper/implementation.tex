\section{Реализация}

\subsection{Генерирование ограниченного интерфейса}

Как обсуждалось в \ref{text:limited-interface}, необходим способ ограничивать
функционал генерируемого интерфейса, чтобы выставлять только те элементы,
использование которых не может нарушить внутренние инварианты системы.

Еще необходимо уметь генерировать имена для получаемого интерфейса:
правила именования в Agda и Haskell отличаются.

Поэтому было решено ввести прагму
\[
\texttt{\{-\# EXPORT \(AgdaName\) \(HaskellName\) \#-\}},
\]
которая пишется в том же модуле \(AgdaModuleName\), где определяется \(AgdaName\).

Если тип \(AgdaName\) не может быть сконвертирован в аналогичный тип на Haskell
или \(HaskellName\) не соблюдает правила именования, то компиляция завершится с ошибкой.

На этапе компиляции вместе с \texttt{MAlonzo.Code.\(AgdaModuleName\)}, где хранится
код генерируемый MAlonzo, будет сгенерирован \texttt{MAlonzo.Export.\(AgdaModuleName\)},
в котором находится весь генерируемый интерфейс.

Решение создать отдельный модуль \texttt{MAlonzo.Export} вызвано желанием скрыть
сгенерированный MAlonzo код от пользователя. В том числе это позволит
при генерировании документации с помощью
haddock\footnote{\url{http://www.haskell.org/haddock/}} отображать только желаемый
интерфейс.

\subsection{Встраивание в MAlonzo}

Вместо изменения кода, который генерирует MAlonzo было решено генерировать
обертки, имеющие нужный интерфейс и вызывающие код, сгенерированный MAlonzo.
Это позволяет менять меньше кода в MAlonzo, хотя может повлиять на производительность ---
оборачивание функций может быть не отброшено оптимизатором.

Кодогенерация вызывается на следующих участках:
\begin{enumerate}
\item При начале обработки модуля \(AgdaModuleName\) компилятором MAlonzo,
      контекст, содержащий сгенерированный код, обнуляется.
\item После обработки каждого определения \(AgdaName\): функции или типа данных -
      проверяется наличие прагмы \texttt{\{-\# EXPORT \(AgdaName\) \(HaskellName\) \#-\}}.
      Если она не найдена, это определение пропускается; иначе - выполняется проверка
      на возможность сгенерировать интерфейс на Haskell. При неудаче выдается ошибка,
      иначе - в контекст добавляется сгенерированные обертки.
\item После обработки модуля, если контекст не пуст, создается модуль \texttt{MAlonzo.Export.\(AgdaModuleName\)}
      в который записывается код контекста.
\end{enumerate}

\subsection{Выполняемая кодогенерация}

Формально задается в приложении \ref{sec:appendix-transformations}.
Корректность доказывается в приложении \ref{sec:appendix-proof}.

\subsubsection{Типы данных}

Типы данных (\textbf{data}, \textbf{record}) экспортируются как \textbf{newtype},
а не \textbf{data}.

\subsubsection{Функции}

Полиморфизм по-Черчу преобразуется в полиморфизм по-Карри.
